<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Example UI</title>
    <style>
        div {
            margin: 1px;
            padding: 4px;
        }
        .container {
            display: flex;
        }
        .left {
            background-color: wheat;
        }
        .right {
            margin-left: auto;
        }
        .outer {
            background-color: pink;
        }
        .middle {
            background-color: lightskyblue;
        }
        .inner {
            background-color: aquamarine;
        }
        .sink {
            align-self: flex-end;
        }
        select {
            overflow-y: auto;
            min-width: 50%;
        }
        .managed {
            background-color: blueviolet;
        }
        .warning {
            background-color: red;
        }
    </style>
    <script>
        // Default classes to display
        let classes = [
            {
                name: "447",
                canvasId: "123",
                recitations: ["10a", "12p"]
            },
            {
                name: "449",
                canvasId: "456",
                recitations: ["11a", "1p"]
            }
        ]

        function get_selected_child_index(element) {
            for(let i = 0; i < element.children.length; i++) {
                if (element.children[i].selected) {
                    return i
                }
            }
        }

        function is_event(obj) {
            return Event.prototype.isPrototypeOf(obj)
        }

        function update_class_ui() {
            const classes_elem = document.getElementById('classes')
            const selected_child_index = get_selected_child_index(classes_elem)
            const selected_child = classes_elem.children.item(selected_child_index)

            const name_elem = document.getElementById('className')
            const recitations_elem = document.getElementById('recitations')
            const canvas_id_elem = document.getElementById('classCanvasID')
            const recitation_time_elem = document.getElementById('recitationTime')

            name_elem.value = selected_child.innerText
            canvas_id_elem.value = selected_child.dataset.canvasID
            const recitations = JSON.parse(selected_child.dataset.recitations)

            for(let i = recitations_elem.childElementCount; i > 0; i--) {
                recitations_elem.removeChild(recitations_elem.firstElementChild)
            }
            recitation_time_elem.value = ""

            for(let rec of recitations) {
                add_new_recitation(rec)
            }
            if(recitations_elem.children.length) {
                recitations_elem.firstElementChild.selected = true
                update_recitation_ui()
            }
        }

        function update_recitation_ui() {
            const recitations_elem = document.getElementById('recitations')
            const recitation_time_elem = document.getElementById('recitationTime')

            if(!recitations_elem.children.length) {
                recitation_time_elem.value = ""
                return
            }

            const selected_child_index = get_selected_child_index(recitations_elem)
            const selected_child = recitations_elem.children.item(selected_child_index)

            recitation_time_elem.value = selected_child.innerText
        }

        function remove_recitation() {
            const recitations_elem = document.getElementById('recitations')
            let selected_index = get_selected_child_index(recitations_elem)
            const selected = recitations_elem.children.item(selected_index)
            recitations_elem.removeChild(selected)

            if(recitations_elem.firstElementChild) {
                recitations_elem.firstElementChild.selected = true
                update_recitation_ui()
            } else {
                document.getElementById('recitationTime').value = ""
            }
        }

        function add_new_course(new_course) {
            if(!new_course || is_event(new_course)) {
                new_course = {
                    name: "new course",
                    canvasId: "0",
                    recitations: []
                }
            }
            const new_course_elem = document.createElement('option')

            new_course_elem.innerText = new_course.name
            new_course_elem.dataset.canvasID = new_course.canvasId
            new_course_elem.dataset.recitations = JSON.stringify(new_course.recitations)

            document.getElementById('classes').appendChild(new_course_elem)

            new_course_elem.selected = true
            update_class_ui()
        }

        function add_new_recitation(new_rec) {
            if(!new_rec || is_event(new_rec)) {
                new_rec = "8am"
            }

            const new_rec_elem = document.createElement('option')
            new_rec_elem.innerText = new_rec

            const recs_elem = document.getElementById('recitations')
            recs_elem.appendChild(new_rec_elem)

            new_rec_elem.selected = true
            update_recitation_ui()
        }

        function remove_course () {
            const classes_elem = document.getElementById('classes')
            let selected_index = get_selected_child_index(classes_elem)
            const selected = classes_elem.children.item(selected_index)

            classes_elem.removeChild(selected)
            if(selected_index > 0) selected_index -= 1
            classes_elem.children.item(selected_index).selected = true
            update_class_ui()
        }

        function update_course() {
            const class_name_elem = document.getElementById('className')
            const class_id_elem = document.getElementById('classCanvasID')
            const classes_elem = document.getElementById('classes')

            const selected_index = get_selected_child_index(classes_elem)
            const selected = classes_elem.children.item(selected_index)

            const recitations_elem = document.getElementById('recitations')
            let recs = []
            for(let child of recitations_elem.children) {
                recs.push(child.innerText)
            }

            selected.innerText = class_name_elem.value
            selected.dataset.canvasID = class_id_elem.value
            selected.dataset.recitations = JSON.stringify(recs)
        }

        function update_rec() {
            const rec_time_elem = document.getElementById('recitationTime')
            const recs_elem = document.getElementById('recitations')
            const selected_index = get_selected_child_index(recs_elem)
            const selected = recs_elem.children.item(selected_index)

            selected.innerText = rec_time_elem.value
        }

        function send_config() {
            const courses_elem = document.getElementById('classes')

            let config_classes = []
            for(let child of courses_elem.children) {
                let this_class = {
                    name: child.innerText,
                    canvasID: child.dataset.canvasID,
                    recitations: JSON.parse(child.dataset.recitations)
                }
                config_classes.push(this_class)
            }

            const config = {
                template: [],
                classes: config_classes
            }

            console.log(config)

            let headers = new Headers()
            headers.append('Content-type', 'application/json')

            let fetch_options = {
                headers: headers,
                method: "POST",
                body: JSON.stringify(config)
            }

            fetch("/config", fetch_options)
                .then((response) => {
                    return response.json()
                })
                .then((response) => {
                    // TODO: do something with this
                    console.log(response)
                })
                .catch((err) => {
                    console.log(err)
                })
        }

        function get_current_json() {
            fetch("/get_server_json")
                .then((response) => {
                    return response.json()
                })
                .then((response) => {
                    console.log(response)
                    fill_out_server_panel(response)
                })
        }

        function fill_out_server_panel(config) {
            let server_elem = document.getElementById('server')
            for(let entry of config) {
                if(entry.channels) {
                    const grp_elem = document.createElement('optgroup')
                    grp_elem.label = entry.name
                    for(let chan of entry.channels) {
                        const chan_elem = document.createElement('option')
                        chan_elem.innerText = chan.name
                        grp_elem.appendChild(chan_elem)
                    }
                    server_elem.appendChild(grp_elem)
                } else {
                    const chan_elem = document.createElement('option')
                    chan_elem.innerText = entry.name
                    server_elem.appendChild(chan_elem)
                }
            }
        }

        function onload() {
            for(let sem_class of classes) {
                add_new_course(sem_class)
            }

            const classes_elem = document.getElementById("classes")
            classes_elem.firstElementChild.selected = true
            update_class_ui()

            classes_elem.addEventListener("change", update_class_ui)

            document.getElementById('addClassBtn').addEventListener("click", add_new_course)
            document.getElementById('removeClassBtn').addEventListener("click", remove_course)

            document.getElementById('className').addEventListener('input', update_course)
            document.getElementById('classCanvasID').addEventListener('change', update_course)

            document.getElementById('recitations').addEventListener("change", update_recitation_ui)

            document.getElementById('rmRecBtn').addEventListener('click', remove_recitation)
            document.getElementById('addRecBtn').addEventListener('click', add_new_recitation)

            const rec_time_elem = document.getElementById('recitationTime')
            rec_time_elem.addEventListener('input', update_rec)
            rec_time_elem.addEventListener('change', update_course)

            document.getElementById('semCommitBtn').addEventListener('click', send_config)

            get_current_json()
        }

        addEventListener("DOMContentLoaded", onload)
    </script>
</head>
<body>
<form id="theForm">
    <div class="container">
        <div class="left">
            <label for="server">Current Server Outline</label><br />
            <select id="server" name="serverOutline" size="20">
            </select>
        </div>
        <div class="outer">
            <div class="middle container">
                <div class="inner">
                    <label for="classTemplate">Templates per class<br />
                        <small>(Categories will be inserted at the bottom of the current hierarchy)</small></label><br />
                    <select id="classTemplate" size="10">
                        <option>Announcements</option>
                        <option>qa-forum</option>
                        <option>general</option>
                        <option>assignment-discussion</option>
                        <option>ta-chat</option>
                    </select> <br />
                    <button type="button">Add Channel</button>
                </div>
                <div class="inner">
                    <label for="channelName">Channel Name</label><br />
                    <input type="text" id="channelName"><br />
                    <fieldset>
                        <legend>Channel Type</legend>
                        <input type="radio" id="announcement" name="channelType" value="A">
                        <label for="announcement">Announcements</label><br />
                        <input type="radio" id="textChannel" name="channelType" value="T" checked>
                        <label for="textChannel">Text</label><br />
                        <input type="radio" id="voiceChannel" name="channelType" value="V">
                        <label for="voiceChannel">Voice</label><br />
                        <input type="radio" id="forum" name="channelType" value="F">
                        <label for="forum">Forum</label><br />
                    </fieldset><br />
                    <input type="checkbox" id="TAChannelAccess">
                    <label for="TAChannelAccess">TA Only Channel (Announcement channels will be made TA-Writable)</label><br />
                    <input type="checkbox" id="studentOnly">
                    <label for="studentOnly">Make this channel accessible only to students currently in the class</label><br />
                    <div class="container middle">
                        <button type="button">commit configuration</button>
                        <button class="right" type="button">remove channel</button>
                    </div>
                </div>
            </div>
            <br/>
            <div class="middle container sink">
                <div class="inner">
                    <label for="classes">Semester Classes</label><br />
                    <select id="classes" name="classes" size="5">
                    </select><br />
                    <button type="button" id="addClassBtn">Add Course</button>
                </div>
                <div class="inner">
                    <label for="className">Class Name</label><br />
                    <input type="text" id="className"><br />
                    <label for="classCanvasID">Canvas ID</label><br />
                    <input type="text" id="classCanvasID"><br />
                    <button type="button" id="removeClassBtn">Remove Course</button>
                </div>
                <div class="inner">
                    <label for="recitations">Class Recitation Sections</label><br />
                    <select id="recitations" name="recitations" size="5">
                    </select><br />
                    <button type="button" id="addRecBtn">Add Recitation Section</button>
                    <button type="button" id="rmRecBtn">Remove Recitation</button><br />
                    <label for="recitationTime">Recitation Time</label>
                    <input type="text" id="recitationTime"><br />
                </div>
                <div class="inner">
                    <button type="button" id="previewBtn">Preview Changes in Left Panel</button><br /><br />
                    <button type="button" id="semCommitBtn">Commit Semester Options</button>
                </div>
                <div class="inner">
                    <button class="warning" type="button">Semester Cleanup</button><br />
                    <p>Warning! This will ERASE all <span class="managed">managed</span> categories, and migrate current students and TAs to former-student roles. Logs for each channel will be downloaded.</p>
                </div>
            </div>
        </div>
    </div>
</form>
</body>
</html>